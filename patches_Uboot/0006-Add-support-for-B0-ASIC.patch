From a77236d4ef772ddff0e18c1d419a592b80ee1fa7 Mon Sep 17 00:00:00 2001
From: Marek Bykowski <marek.bykowski@gmail.com>
Date: Mon, 2 Jul 2018 08:48:26 -0500
Subject: [PATCH 06/13] Add support for B0 ASIC.

Uboot lets ATF know it is booting B0.

Signed-off-by: Marek Bykowski <marek.bykowski@gmail.com>
---
 common/board_f.c | 42 ++++++++++++++++++++++++++++++++++++++++--
 1 file changed, 40 insertions(+), 2 deletions(-)

diff --git a/common/board_f.c b/common/board_f.c
index 56da4a9522..e7b6d9802b 100644
--- a/common/board_f.c
+++ b/common/board_f.c
@@ -794,9 +794,41 @@ int flush_all(void)
 	return 0;
 }
 
+/* Copied/pasted from SPL */
+
+/*
+  ------------------------------------------------------------------------------
+  is_xlf_a0
+
+  Detect A0 parts, which need to be configured slightly differently.
+  Display a warning if the part is unfused, and assume !A0 in that
+  case.
+*/
+
+#ifdef CONFIG_AXXIA_ANY_XLF
+int
+is_xlf_a0(void)
+{
+	if (0 == pfuse) {
+		unsigned int value;
+
+		/* Handle Un-Fused Parts */
+		ncr_read32(NCP_REGION_ID(0x16, 0xff), 0, &value);
+
+		if (1 == ((value >> 8) & 0x7))
+			return 0; /* B0 */
+	} else if (0 != ((pfuse & 0x700) >> 8)) {
+		return 0;	/* B0 */
+	}
+
+	return 1;		/* A0 */
+}
+#endif	/* CONFIG_AXXIA_ANY_XLF */
+
 typedef enum {
 	AXXIA_5600 = 0,
-	AXXIA_6700 = 1
+	AXXIA_6700 = 1,
+	AXXIA_6700_B0 = 2
 } axxia_target_t;
 
 typedef enum {
@@ -832,7 +864,13 @@ int switch_to_EL2_non_secure(void)
 	axxia_configuration->target = AXXIA_5600;
 	axxia_configuration->platform = AXXIA_HW;
 #elif defined(CONFIG_AXXIA_XLF)
-	axxia_configuration->target = AXXIA_6700;
+	asm volatile("mb: b mb\n");
+	if (0 != is_xlf_a0()) {
+		axxia_configuration->target = AXXIA_6700;
+	} else {
+		axxia_configuration->target = AXXIA_6700_B0;
+		printf("mb: passing AXXIA_6700_B0\n");
+	}
 	axxia_configuration->platform = AXXIA_HW;
 #endif
 	axxia_configuration->option = AXXIA_NONE;
-- 
2.16.2

